#!/usr/sbin/nft -f

# nftables configuration for wan0/wan1 traffic control with NAT

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Accept established and related connections
        ct state established,related accept

        # Accept loopback
        iifname "lo" accept

        # SSH from 126.0.0.0/24 on eth3 (ssh interface)
        iifname "eth3" ip saddr 126.0.0.0/24 tcp dport 22 accept

        # Accept from LAN
        iifname "eth2" accept

        # Log dropped packets (optional)
        # log prefix "INPUT DROP: " drop
    }

    chain forward {
        type filter hook forward priority 0; policy accept;
        
        # Accept established and related connections
        ct state established,related accept
        
        # Allow forwarding from LAN to WAN
        iifname "eth2" oifname { "eth0", "eth1" } accept
        
        # Allow forwarding from WAN to LAN (for established connections)
        iifname { "eth0", "eth1" } oifname "eth2" ct state established,related accept
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}

table inet nat {
    chain prerouting {
        type nat hook prerouting priority -100;
    }

    chain postrouting {
        type nat hook postrouting priority 100;
        
        # Masquerade outgoing traffic on WAN interfaces
        oifname "eth0" masquerade
        oifname "eth1" masquerade
    }
}
